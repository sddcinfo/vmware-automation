#cloud-config
autoinstall:
  version: 1
  # Prevent the installer from trying to update itself, which can cause prompts.
  refresh-installer:
    update: false
  # Set a non-interactive identity.
  identity:
    hostname: ubuntu-vm
    password: "!" # A dummy password is required but will be locked.
    username: "ubuntu"
  # Add a user with sudo access and an SSH key for authentication.
  user-data:
    users:
      - name: ubuntu
        sudo: ALL=(ALL) NOPASSWD:ALL
        groups: [adm, sudo]
        shell: /bin/bash
        lock_passwd: true
        ssh_authorized_keys:
          # IMPORTANT: Replace this with your public SSH key.
          - "ssh-rsa AAAA..."
  # Configure networking to use DHCP.
  network:
    network:
      version: 2
      ethernets:
        ens33:
          dhcp4: true
  # Configure storage to use the entire disk, wiping it first.
  # This is critical for preventing interactive prompts about disk formatting.
  storage:
    layout:
      name: direct
      match:
        size: largest
    config:
      - type: disk
        id: disk-sda
        ptable: gpt
        wipe: true
        path: /dev/sda
        grub_device: true
      - type: partition
        id: partition-1
        device: disk-sda
        size: 1G
        number: 1
        flag: boot
      - type: partition
        id: partition-2
        device: disk-sda
        size: -1 # Use the rest of the disk
        number: 2
      - type: format
        id: format-1
        volume: partition-1
        fstype: fat32
      - type: format
        id: format-2
        volume: partition-2
        fstype: ext4
      - type: mount
        id: mount-1
        device: format-1
        path: /boot/efi
      - type: mount
        id: mount-2
        device: format-2
        path: /
